# 服务器高并发的相关知识点

<font face="Microsoft Yahei">

1. 一般由于什么问题会造成服务器的高并发.

用12306来举例, 这个系统的痛点一般是下面几点:

    - 不是单纯的去库存问题
    - 爆发式访问. 一般是与秒杀相似的系统特点
    - 全民访问

2. 高并发引起的问题到服务器上的实际业务困境是什么?

    - 首先对服务器有一定的理解.  `以下都是对于单台服务器的各种指标的解读`
        - 服务器天生是多线程的. 能够同时响应多用户的请求. 但线程的数量是有限的. 假设服务器有100个线程(一般由于内存, 硬盘, 带宽等硬件决定的. 达到标准后再进行扩展就非常困难). 一个请求到达服务器需要一定的时间去处理. 假设这个时间是1s(`这里有一定的性能提升空间. 如果将每个请求的处理时间提升为1ms, 则性能会优化1000倍, 效果比提升硬件更客观`). 那么这个服务器1s中最多能够处理100个请求. 那么这个服务器的`吞吐量QPS`为100.如果1s中到达服务器的请求多于吞吐量的话, 会有消息排队在队列当中, 并且如果请求超时会显示回超时...too busy等.
        - 一般来说一个用户5s发起一次请求. 那么服务器可以`承载量`500(100QPS * 5)个在线用户. 
        - `用户活跃度` : 通常来说是1%. 那么这个服务器最多能够支持5w个用户

    - 当用户变多(正常增长). 注册会员变多, 那么只能通过增加服务器. 多台服务器部署的程序都是一样的. 但是它们属于一个`集群`, 请求来到之后, 会通过一些负载均衡的机制均匀的发送给每个服务器. 
    
    - 但是对于高并发的系统, 活跃度属于爆发式增长. 用户活跃度瞬间可以增长20%, 意味着用户活跃度增长了20倍.  以前5s一次的请求变成1s20次请求. 那么请求量扩大了100倍. 两者相乘则扩大了2000倍. 这是秒杀系统的真正痛点.

3. 如何提升服务器吞吐量?

    >`队列 + 命令模式 = 系统架构队列`

    12306的时间损耗一般是在于去库存的逻辑比较复杂.如下图:

   ![](https://img2018.cnblogs.com/blog/1216080/201904/1216080-20190424140801091-435226140.png)


    此时每次client发送的request都要经过server然后经过processor后访问DB, 所以每次request 在server上处理的时间会消耗很长时间. 

    在这个结构的基础上我们在server 与 processor之间增加一个消息队列. 这个队列是基于内存的, 从server发来的request都将进入这个队列中去排队. 然后client将拿到一个等待的response. 这样会大大提升server端的吞吐量.从而提升性能. 进一步来说, processor会控制访问DB的速度, 对DB的访问量也会减小.

    ![](https://img2018.cnblogs.com/blog/1216080/201904/1216080-20190424140249386-1999320202.png)

4. 队列的优缺?

    - 扩展性很强. 有了队列之后程序可以保证数据格式的稳定的情况下, 架构可以随意扩展. 只要保证数据格式稳定.
    - 可用性. 高并发性都放到processor当中.
    - 缺点是: 不能及时拿到结果.降低了用户体验.

